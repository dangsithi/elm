<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBD2 ELM327 v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        button { margin: 5px; padding: 10px 15px; font-size: 16px; }
        canvas { max-width: 600px; margin: 20px auto; display: block; }
        #logData { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>OBD2 ELM327 v1.0</h1>

    <button onclick="connectOBD()">ğŸ”Œ Káº¿t ná»‘i</button>
    <button onclick="startLogging()">ğŸ“Š Báº¯t Ä‘áº§u ghi log</button>
    <button onclick="stopLogging()">â¹ Dá»«ng ghi log</button>
    <button onclick="saveLogData()">ğŸ’¾ LÆ°u dá»¯ liá»‡u</button>
    <button onclick="readDTC()">ğŸ“Ÿ Äá»c lá»—i DTC</button>
    <button onclick="clearDTC()">âŒ XÃ³a lá»—i</button>

    <h2>Biá»ƒu Ä‘á»“ tá»‘c Ä‘á»™ & vÃ²ng tua</h2>
    <canvas id="speedRpmChart"></canvas>

    <h2>Biá»ƒu Ä‘á»“ nhiá»‡t Ä‘á»™ nÆ°á»›c lÃ m mÃ¡t</h2>
    <canvas id="coolantTempChart"></canvas>

    <script>
        let socket;
        let isLogging = false;
        let logData = [];

        // Biá»ƒu Ä‘á»“ tá»‘c Ä‘á»™ & vÃ²ng tua
        const speedRpmCtx = document.getElementById('speedRpmChart').getContext('2d');
        const speedRpmChart = new Chart(speedRpmCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Tá»‘c Ä‘á»™ (km/h)', borderColor: 'blue', data: [], fill: false },
                    { label: 'VÃ²ng tua (RPM)', borderColor: 'red', data: [], fill: false }
                ]
            },
            options: { responsive: true, scales: { x: { }, y: { beginAtZero: true } } }
        });

        // Biá»ƒu Ä‘á»“ nhiá»‡t Ä‘á»™ nÆ°á»›c lÃ m mÃ¡t
        const coolantCtx = document.getElementById('coolantTempChart').getContext('2d');
        const coolantChart = new Chart(coolantCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Nhiá»‡t Ä‘á»™ nÆ°á»›c (Â°C)', borderColor: 'green', data: [], fill: false }] },
            options: { responsive: true, scales: { x: { }, y: { beginAtZero: true } } }
        });

        function connectOBD() {
            socket = new WebSocket("ws://192.168.0.10:35000"); // Cá»•ng máº·c Ä‘á»‹nh ELM327 WiFi
            socket.onopen = () => alert("âœ… ÄÃ£ káº¿t ná»‘i vá»›i OBD2!");
            socket.onmessage = event => processOBDData(event.data);
            socket.onerror = () => alert("âŒ Lá»—i káº¿t ná»‘i OBD2!");
            socket.onclose = () => alert("ğŸ”Œ Máº¥t káº¿t ná»‘i OBD2!");
        }

        function processOBDData(data) {
            let speed = Math.floor(Math.random() * 100);  // Giáº£ láº­p tá»‘c Ä‘á»™
            let rpm = Math.floor(Math.random() * 5000);   // Giáº£ láº­p vÃ²ng tua
            let coolantTemp = Math.floor(Math.random() * 100); // Giáº£ láº­p nhiá»‡t Ä‘á»™

            let time = new Date().toLocaleTimeString();

            if (speedRpmChart.data.labels.length > 20) { speedRpmChart.data.labels.shift(); speedRpmChart.data.datasets[0].data.shift(); speedRpmChart.data.datasets[1].data.shift(); }
            speedRpmChart.data.labels.push(time);
            speedRpmChart.data.datasets[0].data.push(speed);
            speedRpmChart.data.datasets[1].data.push(rpm);
            speedRpmChart.update();

            if (coolantChart.data.labels.length > 20) { coolantChart.data.labels.shift(); coolantChart.data.datasets[0].data.shift(); }
            coolantChart.data.labels.push(time);
            coolantChart.data.datasets[0].data.push(coolantTemp);
            coolantChart.update();

            if (isLogging) {
                logData.push([time, speed, rpm, coolantTemp]);
            }
        }

        function startLogging() {
            isLogging = true;
            logData = [];
            alert("ğŸ“Š Báº¯t Ä‘áº§u ghi log dá»¯ liá»‡u!");
        }

        function stopLogging() {
            isLogging = false;
            alert("â¹ Dá»«ng ghi log!");
        }

        function saveLogData() {
            if (logData.length === 0) {
                alert("â›” KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ lÆ°u!");
                return;
            }

            let now = new Date();
            let timestamp = now.getFullYear() + ("0" + (now.getMonth() + 1)).slice(-2) + ("0" + now.getDate()).slice(-2) + "_" +
                            ("0" + now.getHours()).slice(-2) + ("0" + now.getMinutes()).slice(-2) + ("0" + now.getSeconds()).slice(-2);

            let filename = `log_${timestamp}.csv`;

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Thá»i gian,Tá»‘c Ä‘á»™ (km/h),VÃ²ng tua (RPM),Nhiá»‡t Ä‘á»™ nÆ°á»›c (Â°C)\n";
            logData.forEach(row => csvContent += row.join(",") + "\n");

            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function readDTC() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send("03");  // Gá»­i lá»‡nh Ä‘á»c mÃ£ lá»—i
                alert("ğŸ“Ÿ Äá»c mÃ£ lá»—i DTC...");
            }
        }

        function clearDTC() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send("04");  // Gá»­i lá»‡nh xÃ³a lá»—i
                alert("âŒ ÄÃ£ xÃ³a mÃ£ lá»—i!");
            }
        }
    </script>
</body>
</html>
